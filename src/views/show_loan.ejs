<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <header class="dashboard-header">
      <div>
        <h1><%= loan.name %></h1>
        <p>Loan Details</p>
      </div>
      <a href="/" class="btn-secondary">Back to Dashboard</a>
    </header>

    <div class="loan-details">
      <div class="detail-card">
        <h2>Overview</h2>
        <div class="detail-row">
          <span class="label">Status:</span>
          <span class="status-badge <%= loan.status.toLowerCase() %>"><%= loan.status %></span>
        </div>
        <div class="detail-row">
          <span class="label">Lender:</span>
          <span class="value"><%= loan.lender %></span>
        </div>
        <div class="detail-row">
          <span class="label">Borrower:</span>
          <span class="value"><%= loan.borrower %></span>
        </div>
      </div>

      <div class="detail-card">
        <h2>Financials</h2>
        <div class="detail-row">
          <span class="label">Principal Amount:</span>
          <span class="value">₹<%= loan.amount.toLocaleString() %></span>
        </div>
        <div class="detail-row">
          <span class="label">Interest Rate:</span>
          <span class="value"><%= loan.interest_rate %>% per annum</span>
        </div>
        <div class="detail-row">
          <span class="label">Accrued Interest:</span>
          <span class="value text-highlight">₹<%= loan.interest_accrued %></span>
        </div>
        <div class="detail-row total-row">
          <span class="label">Total Due:</span>
          <span class="value text-bold">₹<%= Number(loan.total_amount).toLocaleString() %></span>
        </div>
      </div>

      <div class="detail-card">
        <h2>Timeline</h2>
        <div class="detail-row">
          <span class="label">Start Date:</span>
          <span class="value"><%= loan.start_date %></span>
        </div>
        <div class="detail-row">
          <span class="label">Duration:</span>
          <span class="value"><%= loan.duration_months %> Months</span>
        </div>
        <div class="detail-row">
          <span class="label">Elapsed:</span>
          <span class="value"><%= loan.days_elapsed %> Days</span>
        </div>
      </div>
    </div>

    <div class="chart-section">
      <h2>Growth Over Time</h2>
      <div class="chart-container">
        <canvas id="growthChart"></canvas>
      </div>
    </div>

    <div class="calculation-section">
      <h2>Interest Calculation Details</h2>
      <p class="info-text">
        This loan uses <strong>Simple Interest</strong>. The formula is <code>Interest = Principal × Rate × Time</code>.
        <br>
        <em>Note: Time is calculated in years (Days / 365).</em>
      </p>
      
      <div class="table-responsive">
        <table class="loan-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Days Elapsed</th>
              <th>Principal</th>
              <th>Interest Accrued</th>
              <th>Total Value</th>
              <th>Explanation</th>
            </tr>
          </thead>
          <tbody>
            <% if (typeof growthSchedule !== 'undefined') { %>
              <% growthSchedule.forEach(function(row) { %>
                <tr>
                  <td><%= row.date %></td>
                  <td><%= row.days_elapsed %></td>
                  <td>₹<%= loan.amount.toLocaleString() %></td>
                  <td class="text-highlight">+₹<%= Number(row.interest_accrued).toLocaleString() %></td>
                  <td class="text-bold">₹<%= Number(row.total).toLocaleString() %></td>
                  <td class="text-muted"><%- row.note %></td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('growthChart').getContext('2d');
    const chartData = <%- typeof chartData !== 'undefined' ? JSON.stringify(chartData) : 'null' %>;
    
    if (chartData) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [
            {
              label: 'Principal',
              data: chartData.principalData,
              borderColor: '#6c757d',
              backgroundColor: 'rgba(108, 117, 125, 0.1)',
              borderDash: [5, 5],
              fill: false,
              tension: 0.1
            },
            {
              label: 'Total Amount (with Interest)',
              data: chartData.totalData,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              fill: true,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += '₹' + context.parsed.y.toLocaleString();
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: function(value) {
                  return '₹' + value;
                }
              }
            }
          }
        }
      });
    } else {
      document.querySelector('.chart-section').style.display = 'none';
    }
  </script>
</body>
</html>
